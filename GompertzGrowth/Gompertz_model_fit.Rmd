---
title: "Gompertz Nonlinear Statistical Modelling of COVID-19 Outbreak in Italy's regions"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: false
    css: "../COVID-19-IT.css"
---

```{R, echo=FALSE, eval=FALSE}
# 
# use this chunk to produce the analysis for all the regions
# 
regioni = c("Piemonte", "Valle d'Aosta", "Liguria", 
            "Lombardia", "P.A. Bolzano", "P.A. Trento", 
            "Veneto", "Friuli Venezia Giulia", "Emilia-Romagna", 
            "Toscana", "Umbria", "Marche", "Lazio", "Abruzzo", 
            "Molise", "Campania", "Puglia", "Basilicata", 
            "Calabria", "Sicilia", "Sardegna")
for(regione in regioni) 
{
  rmarkdown::render("misc/Gompertz_model_fit.Rmd", 
                    params = list(regione = regione), 
                    output_file = paste0("Gompertz_model_fit", "_", regione, ".html"))
}
```


<br><br>

```{R setup, echo=FALSE}
source("../setup.R", chdir = TRUE)
library(ggplot2)
library(data.table)

Gompertz_gradient <- function(x, th)
{
  -th[1] * th[2] * th[3]^x * log(th[3]) * exp(-th[2] * th[3]^x)
}

Gompertz_point_inflection <- function(th)
{ 
  unname(-log(th[2])/log(th[3]))
}

day2date <- function(x, origin) as.Date(as.numeric(x), origin = origin)

cols = c("black", tableau_color_pal(palette = "Classic 10")(10))
```

```{R, fig.width=6, fig.height=5, out.width="90%"}
# regione = "Umbria"
url = "https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv"
COVID19 = fread(url)
COVID19$data = as.Date(COVID19$data)
COVID19 = COVID19[denominazione_regione == regione]
COVID19 = COVID19[,c("data", "totale_casi", "tamponi")]
COVID19[, tamponi := (shift(tamponi,1) + tamponi)/2]
COVID19[, new_casi := totale_casi - shift(totale_casi,1)]
COVID19[, new_tamponi := tamponi - shift(tamponi,1)]
COVID19 = COVID19[totale_casi > 0,]
COVID19 = na.omit(COVID19)
COVID19 = COVID19[new_tamponi > 0]
COVID19[, day := as.numeric(data - min(data) + 1)]


grid.arrange(qplot(data, totale_casi, data = COVID19),
             qplot(data, tamponi, data = COVID19),
             qplot(data, totale_casi/tamponi, data = COVID19),
             top = regione)
             
# Model total cases ----

# mod0 = nls(totale_casi ~ SSgompertz(day, th1, th2, th3), data = COVID19)
# summary(mod0)
# confint(mod0)
# Gompertz_point_inflection(coef(mod0))
# data_point_inflection = day2date(Gompertz_point_inflection(coef(mod0)), 
#                                  origin = min(COVID19$data)-1)
#   
# qplot(data, totale_casi, data = COVID19) +
#   geom_line(aes(y = fitted(mod0)), col = 3) +
#   geom_vline(xintercept = data_point_inflection, lty = 2)
# 
# qplot(data, new_casi, data = COVID19) +
#   geom_line(aes(y = Gompertz_gradient(COVID19$day, coef(mod0))), col = 3) +
#   geom_vline(xintercept = data_point_inflection, lty = 2)

# n = length(fitted(mod0))
# nboot = 999
# coef_boot <- matrix(as.double(NA), nboot, length(coef(mod0))+1)
# for(b in 1:nboot)
# {
#   wts = rexp(n); wts = wts/mean(wts)
#   mod0_boot = nls(totale_casi ~ SSgompertz(day, th1, th2, th3), data = COVID19, weights = wts)
#   coef_boot[b,] = c(coef(mod0_boot), Gompertz_point_inflection(coef(mod0_boot)))
# }
# t(apply(coef_boot, 2, quantile, prob = c(0.025, 0.975)))


# Model total cases / swabs ----

wts = with(COVID19, tamponi/mean(tamponi))
mod = nls(totale_casi ~ SSgompertz(day, th1, th2, th3), data = COVID19, 
           weights = wts,
           control = nls.control(maxiter = 1000))
summary(mod)
confint(mod)


data_point_inflection2 = as.Date(Gompertz_point_inflection(coef(mod)), 
                                 origin = min(COVID19$data)-1)

n = length(fitted(mod))
nboot = 999
coef_boot <- matrix(as.double(NA), nboot, length(coef(mod))+1)
for(b in 1:nboot)
{
  idx = MBB(1:n, block.size = 7)
  wts = weights(mod)*rexp(n); wts = wts/mean(wts)
  mod_boot = try(nls(totale_casi ~ SSgompertz(day, th1, th2, th3),
                     data = COVID19[idx,], weights = wts[idx],
                     control = nls.control(maxiter = 1000)),
                  silent = TRUE)
  if(inherits(mod_boot, "try-error"))
  {
    b <- b-1
    next
  }
  coef_boot[b,] = c(coef(mod_boot), Gompertz_point_inflection(coef(mod_boot)))
}

tab = data.frame(Estimate = c(coef(mod), "pt_inflection" = Gompertz_point_inflection(coef(mod))))
tab = cbind(tab, t(apply(coef_boot, 2, quantile, prob = c(0.025, 0.975), na.rm = TRUE)))
tab
(data_point_inflection = day2date(tab[4,], origin = min(COVID19$data)-1))
  
ggplot(COVID19, aes(x = data, y = totale_casi)) +
  geom_point(aes(size = wts), pch = 1) +
  geom_line(aes(y = fitted(mod)), col = cols[2]) +
  geom_vline(xintercept = data_point_inflection[1], lty = 2, col = cols[2]) +
  geom_hline(yintercept = coef(mod)[1], lty = 2, col = cols[2]) +
  geom_pointrange(aes(x = max(data)+3, y = tab[1,1], 
                      ymin = tab[1,2], ymax = tab[1,3]), col = cols[2]) +
  geom_pointrange(aes(y = 0, x = data_point_inflection[1], 
                      xmin = data_point_inflection[2], 
                      xmax = data_point_inflection[3]), col = cols[2]) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  labs(title = regione) + xlab("") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle=60, hjust=1))

ggplot(COVID19, aes(x = data, y = new_casi)) +
  geom_point(aes(size = wts), pch = 1) +
  geom_line(aes(y = Gompertz_gradient(COVID19$day, coef(mod))), col = cols[2]) +
  geom_vline(xintercept = data_point_inflection[1], lty = 2, col = cols[2]) +
  geom_pointrange(aes(y = 0, x = data_point_inflection[1], 
                      xmin = data_point_inflection[2], 
                      xmax = data_point_inflection[3]), col = cols[2]) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  labs(title = regione) + xlab("") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle=60, hjust=1))
```

```{R, fig.width=6, fig.height=5, out.width="90%"}
# beta_t = contact rate or growth rate of the epidemic
# gamma = recovery rate, set as 
gamma = 1 / 7.5
# i.e. 7.5 days to recover, i.e. expected incubation time
COVID19[, yhat := predict(mod) ]
COVID19[, beta_t := c(NA, diff(yhat)/frollsum(shift(diff(yhat)), 7))]
COVID19[, R_t := beta_t / gamma ]

ggplot(COVID19, aes(x = data, y = R_t)) +
  geom_point(col = cols[2]) + geom_line(col = cols[2]) + 
  geom_hline(yintercept = 1, lty = 2) +
  scale_y_continuous(breaks = seq(0, 3, by = 0.5), limits = c(0,3)) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  labs(title = regione) + xlab("") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle=60, hjust=1))
```

