---
title: "Gompertz Nonlinear Statistical Modelling of COVID-19 Outbreak in Italy's regions"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: false
    css: "../COVID-19-IT.css"
---

<br><br>

```{R setup, echo=FALSE}
source("setup.R")
```

```{R data, fig.width=6, fig.height=5, out.width="90%"}
url = "https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-regioni/dpc-covid19-ita-regioni.csv"
COVID19 = data.table::fread(url)
COVID19$data = as.Date(COVID19$data)
COVID19 = COVID19[data <= date]                      # subset date
COVID19 = COVID19[denominazione_regione == regione]  # subset region
#
COVID19 = COVID19[,c("data", "totale_casi", "tamponi")]
# ensure that series are not decreasing
COVID19[, totale_casi := pmax(totale_casi, shift(totale_casi,1), na.rm = TRUE)]
COVID19[, tamponi := pmax(tamponi, shift(tamponi,1), na.rm = TRUE)]
#
COVID19[, tamponi := (shift(tamponi,1) + tamponi)/2]
COVID19[, new_casi := totale_casi - shift(totale_casi,1)]
COVID19[, new_tamponi := tamponi - shift(tamponi,1)]
COVID19 = COVID19[totale_casi > 0,]
COVID19 = na.omit(COVID19)
COVID19 = COVID19[new_tamponi > 0]
COVID19[, day := as.numeric(data - min(data) + 1)]
COVID19[, wts := tamponi/mean(tamponi)]

# grid.arrange(qplot(data, totale_casi, data = COVID19),
#              qplot(data, tamponi, data = COVID19),
#              qplot(data, totale_casi/tamponi, data = COVID19),
#              top = regione)
```

```{R fit}
# Exponential fit
mod1 = try(nls(totale_casi ~ SSexponential(day, th1, th2), data = COVID19, 
               weights = wts, algorithm = "default",
               control = nls.control(maxiter = 1000)),
           silent = TRUE)
if(inherits(mod1, "try-error")) mod1 <- NULL
summary(mod1)

# Gompertz fit
mod2 = try(nls(totale_casi ~ Gompertz(day, asym, rate, infl), data = COVID19, 
               weights = wts, algorithm = "default",
               control = nls.control(maxiter = 1000)),
           silent = TRUE)
if(inherits(mod2, "try-error")) mod2 <- NULL
summary(mod2)

models = list("Exponential model" = mod1,
              "Gompertz model" = mod2)
tab = data.frame(t(sapply(models, nlsModelTable)), check.names = FALSE)
sel = apply(tab[,4:6], 2, which.min)
tab$"" <- sapply(tabulate(sel, nbins = length(models))+1, symnum,
                 cutpoints = 0:4, symbols = c("", "*", "**", "***"))
modelSelected = which.max(nchar(tab[,ncol(tab)]))
knitr::kable(tab)
```

```{R bootstrap}
nboot = 999
n = nrow(COVID19)
coef_boot = matrix(as.double(NA), nboot, 4)

for(b in 1:nboot)
{
  # Moving block Bayesian bootstrap
  idx = MBB(1:n, block.size = 7)
  
  if(modelSelected == 1)
  {
    wts_boot = weights(mod1)*rexp(n); wts_boot = wts_boot/mean(wts_boot)
    # wts_boot = weights(mod1)
    mod_boot = try(nls(totale_casi ~ SSexponential(day, th1, th2),
                       data = COVID19[idx,], weights = wts_boot[idx],
                       control = nls.control(maxiter = 1000)),
                   silent = TRUE)
  } else
  {
    wts_boot = weights(mod2)*rexp(n); wts_boot = wts_boot/mean(wts_boot)
    # wts_boot = weights(mod2)
    mod_boot = try(nls(totale_casi ~ Gompertz(day, asym, rate, infl),
                       data = COVID19[idx,], weights = wts_boot[idx],
                       control = nls.control(maxiter = 1000)),
                   silent = TRUE)
  }
  if(inherits(mod_boot, "try-error")) { b = b-1; next }
  
  coef_boot[b,] = c(if(modelSelected == 1) c(coef(mod_boot), NA) else coef(mod_boot),
                    if(modelSelected == 1) 
                      Exponential_R0(max(COVID19$day), coef(mod_boot), ET = 7.5)
                    else
                      Gompertz_R0(max(COVID19$day), coef(mod_boot), ET = 7.5) )
}

tab = data.frame(Estimate = c(if(modelSelected == 1) c(coef(mod1), th3 =NA) else coef(mod2), 
                              "R0" = if(modelSelected == 1) 
                                       Exponential_R0(max(COVID19$day), coef(mod1), ET = 7.5)
                                     else
                                       Gompertz_R0(max(COVID19$day), coef(mod2), ET = 7.5)))
tab = cbind(tab, t(apply(coef_boot, 2, quantile, prob = c(0.025, 0.975), na.rm = TRUE)))
tab

# save results
out = rbind(c(regione, unlist(c(tab))))
colnames(out) = c("Regione", outer(rownames(tab), colnames(tab), function(x, y) paste(x, y, sep = "|")))
fwrite(out, file = "results.csv", append = TRUE)
```


```{R plot_growth, fig.width=6, fig.height=5, out.width="90%"}
plot = ggplot(COVID19, aes(x = data, y = totale_casi)) +
  geom_point(aes(size = wts), pch = 1) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  labs(title = regione) + xlab("") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle=60, hjust=1))

if(modelSelected == 1) 
{
  plot = plot +
    geom_line(aes(y = fitted(mod1)), col = cols[2])
} else
{
  plot = plot +
    geom_line(aes(y = fitted(mod2)), col = cols[2]) +
    geom_hline(yintercept = coef(mod2)[1], lty = 2, col = cols[2]) +
    geom_pointrange(aes(x = max(data)+3, y = tab[1,1], 
                        ymin = tab[1,2], ymax = tab[1,3]), 
                    shape = 15, size = 0.5, col = cols[2]) +
    geom_vline(xintercept = day2date(tab[3,1], origin = min(COVID19$data)-1), 
               lty = 2, col = cols[2]) +
    geom_pointrange(aes(y = 0, x = day2date(tab[3,1], origin = min(COVID19$data)-1), 
                        xmin = day2date(tab[3,2], origin = min(COVID19$data)-1),
                        xmax = day2date(tab[3,3], origin = min(COVID19$data)-1)),
                    shape = 15, size = 0.5, col = cols[2])
}
plot
```

```{R plot_rateofgrowth, fig.width=6, fig.height=5, out.width="90%"}
plot = ggplot(COVID19, aes(x = data, y = new_casi)) +
  geom_point(aes(size = wts), pch = 1) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  labs(title = regione) + xlab("") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle=60, hjust=1))

if(modelSelected == 1) 
{
  plot = plot +
    geom_line(aes(y = Exponential_gradient(COVID19$day, coef(mod1))), col = cols[2])
} else
{
  plot = plot +
    geom_line(aes(y = Gompertz_gradient(COVID19$day, coef(mod2))), col = cols[2]) +
    geom_vline(xintercept = day2date(tab[3,1], origin = min(COVID19$data)-1), 
               lty = 2, col = cols[2]) +
    geom_pointrange(aes(y = 0, x = day2date(tab[3,1], origin = min(COVID19$data)-1), 
                        xmin = day2date(tab[3,2], origin = min(COVID19$data)-1),
                        xmax = day2date(tab[3,3], origin = min(COVID19$data)-1)),
                    shape = 15, size = 0.5, col = cols[2])
}
plot
```

```{R plot_growth_rate, echo=FALSE, eval=FALSE}
if(modelSelected == 1) 
{
  COVID19[, growth_rate := Exponential_growthrate(COVID19$day, coef(mod1))]
} else
{
  COVID19[, growth_rate := Gompertz_growthrate(COVID19$day, coef(mod2))]
}

ggplot(COVID19, aes(x = data, y = growth_rate)) +
  geom_point(col = cols[2]) + geom_line(col = cols[2]) + 
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  labs(title = regione) + xlab("") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle=60, hjust=1))
```

```{R plot_predictions, fig.width=6, fig.height=5, out.width="90%"}
# compute prediction using Moving Block Bootstrap (MBB) for nls
pred = data.table(day = seq(min(COVID19$day), max(COVID19$day)+14))
pred = cbind(pred, data = as.Date(pred$day, origin = COVID19$data[1]-1))
if(modelSelected == 1) 
{
  pred = cbind(pred, "fit" = predict(mod1, newdata = pred))
  pred[pred$day > max(COVID19$day), c("lwr", "upr")] = 
    predictMBB.nls(mod1, pred[pred$day > max(COVID19$day),], verbose = FALSE)[,2:3]
} else
{
  pred = cbind(pred, "fit" = predict(mod2, newdata = pred))
  pred[pred$day > max(COVID19$day), c("lwr", "upr")] = 
    predictMBB.nls(mod2, pred[pred$day > max(COVID19$day),], verbose = FALSE)[,2:3]
}
kable(pred[!is.na(pred$lwr)], digits = 2)

ggplot(COVID19, aes(x = data, y = totale_casi)) +
  geom_point(aes(size = wts), pch = 1) +
  geom_line(data = pred, aes(x = data, y = fit), col = cols[2]) +
  geom_ribbon(data = pred, aes(x = data, ymin = lwr, ymax = upr), 
              inherit.aes = FALSE, fill = cols[2], alpha=0.3) + 
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  labs(title = regione) + xlab("") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle=60, hjust=1))
```


```{R plot_R0, fig.width=6, fig.height=5, out.width="90%"}
# expected incubation time
# https://en.wikipedia.org/wiki/Incubation_period
E_incubation_time = 7.5 # days
# gamma = average recovery rate
gamma = 1 / E_incubation_time

if(modelSelected == 1) 
{
  # predicted total infected
  COVID19[, yhat := predict(mod1)]  
  # predicted daily infected
  COVID19[, dyhat := Exponential_gradient(COVID19$day, coef(mod1))]
  # predict R0
  COVID19[, R0 := Exponential_R0(COVID19$day, coef(mod1), ET = E_incubation_time ) ]

} else
{
  # predicted total infected
  COVID19[, yhat := predict(mod2)]
  # predicted daily infected
  COVID19[, dyhat := Gompertz_gradient(COVID19$day, coef(mod2))]
  # predict R0
  COVID19[, R0 := Gompertz_R0(COVID19$day, coef(mod2), ET = E_incubation_time ) ]
}
ylim = range(0, if(modelSelected == 1) tab[4,] else min(3, max(COVID19$R0, na.rm=TRUE)))

ggplot(COVID19, aes(x = data, y = R0)) +
  geom_point(col = cols[2]) + geom_line(col = cols[2]) + 
  geom_hline(yintercept = 1, lty = 2) +
  geom_pointrange(aes(x = max(data), y = tab[4,1], ymin = tab[4,2], ymax = tab[4,3]),
                  shape = 15,  width = 0.5, col = cols[2]) +
  coord_cartesian(ylim = ylim) +
  scale_y_continuous(breaks = seq(0, max(ylim), by = 0.5)) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  labs(title = regione) + xlab("") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle=60, hjust=1))
```

