---
title: "Statistical Modelling of COVID-19 Outbreak in Italy"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: false
    css: "COVID-19-IT.css"
---

<br><br>

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(fig.align = "center",
               fig.width = 6, fig.height = 5.5,
               dev.args = list(pointsize=10),
               out.width = "90%", dpi = 300,
               cache = FALSE,
               par = TRUE, # needed for setting hook 
               collapse = TRUE, # collapse input & ouput code in chunks
               warning = FALSE, message = FALSE)

library(ggplot2)
library(gridExtra)
```

# Data 

Dipartimento della Protezione Civile: COVID-19 Italia - Monitoraggio della situazione <http://arcg.is/C1unv>

Source: https://github.com/pcm-dpc/COVID-19 

```{R}
url = "https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-andamento-nazionale/dpc-covid19-ita-andamento-nazionale.csv"
COVID19IT <- read.csv(file = url, stringsAsFactors = FALSE)
COVID19IT$data <- as.Date(COVID19IT$data)
DT::datatable(COVID19IT)
```

Warnings
```
- 10/03/2020: dati Regione Lombardia parziali.
- 11/03/2020: dati Regione Abruzzo non pervenuti.
```

<br>

# Modelling total infected 

```{R}
# create data for analysis
data = data.frame(date = COVID19IT$data,
                  y = COVID19IT$totale_casi)
data$x = as.numeric(data$date) - min(as.numeric(data$date)) + 1

DT::datatable(data, options = list("pageLength" = 5))
```

```{r, echo=FALSE, eval=FALSE}
plot(data$date[-1], diff(data$y), type = "h", lwd = 2)
plot(data$date[-1], diff(data$y)/head(data$y,-1)*100, type = "h", lwd = 2)
plot(data$date[-1], log(data$y[-1]/head(data$y,-1)))
```


## Nonlinear grow models

### Exponential growth model

$$
\mu(x) = \theta_1 \exp\{\theta_2 x\}
$$
where $\theta_1$ is the value at the origin (i.e. $\mu(x=0)$), and $\theta_2$  represents the (constant) relative ratio of change (i.e. $\frac{d\mu(x)}{dx }\frac{1}{\mu(x)} = \theta_2$). Thus, the model describes an increasing (exponential growth if $\theta_2 > 0$) or decreasing (exponential decay if $\theta_2 < 0$) trend with constant relative rate.

```{R}
mod1_start = lm(log(y) ~ x, data = data)
b = unname(coef(mod1_start))
start = list(th1 = log(b[1]), th2 = b[2])
exponential <- function(x, th1, th2) th1 * exp(th2 * x)
mod1 = nls(y ~ exponential(x, th1, th2), data = data, start = start)
summary(mod1)
```

### Logistic growth model

$$
\mu(x) = \frac{\theta_1}{1+\exp\{(\theta_2 - x)/\theta_3\}}
$$
where $\theta_1$ is the upper horizontal asymptote, $\theta_2$ represents the x-value at the inflection point of the symmetric growth curve, and $\theta_3$ represents a scale parameter (and $1/\theta_3$ is the growth-rate parameter that controls how quickly the curve approaches the upper asymptote).

```{R}
mod2 = nls(y ~ SSlogis(x, Asym, xmid, scal), data = data)
summary(mod2)
```

### Gompertz growth model

$$
\mu(x) = \theta_1 \exp\{-\theta_2 \theta_3^x\}
$$
where $\theta_1$ is the horizontal asymptote, $\theta_2$ represents the value of the function at $x = 0$ (displacement along the x-axis), and $\theta_3$ represents a scale parameter.

The difference between the logistic and Gompertz functions is that the latter is not symmetric around the inflection point. 

```{R}
mod3 = nls(y ~ SSgompertz(x, Asym, b2, b3), data = data)
summary(mod3)
```

### Richards growth model

$$
\mu(x) = \theta_1 (1 - \exp\{-\theta_2 x\})^{\theta_3}
$$
where $\theta_1$ is the horizontal asymptote, $\theta_2$ represents the rate of growth, and $\theta_3$  in part determines the point of inflection on the y-axis.

```{R, eval=FALSE}
richards <- function(x, th1, th2, th3) th1*(1 - exp(-th2*x))^th3
Loss  <- function(th, y, x) sum((y - richards(x, th[1], th[2], th[3]))^2) 
start <- optim(par = c(coef(mod2)[1], 0.001, 1), fn = Loss, 
               y = data$y, x = data$x)$par
names(start) <- c("th1", "th2", "th3")
mod4 = nls(y ~ richards(x, th1, th2, th3), data = data, start = start,
           trace = TRUE, # algorithm = "port", 
           control = nls.control(maxiter = 1000, tol = 1e-1))
# algorithm is not converging... 
summary(mod4)
```

### Models comparison

```{R}
models = list("Exponential model" = mod1, 
              "Logistic model" = mod2, 
              "Gompertz model" = mod3)
              # "Richards model" = mod4)
tab = data.frame(loglik = sapply(models, logLik),
                 df = sapply(models, function(m) attr(logLik(m), "df")),
                 Rsquare = sapply(models, function(m) 
                                  cor(data$y, fitted(m))^2),
                 AIC = sapply(models, AIC),
                 BIC = sapply(models, BIC))
knitr::kable(tab)
```

```{r, echo=FALSE}
# create figure with table for inclusion in README.md
ttheme <- ttheme_default(
  core = list(# bg_params = list(fill = NA, col=NA),
              fg_params=list(fontface=1, fontsize = 10)),
  colhead = list(fg_params=list(col="black", fontface=2, fontsize = 10)),
  rowhead = list(fg_params=list(col="black", fontface=2, hjust=0, x=0,
                                fontsize = 10),
                 bg_params=list(fill = c("grey95", "grey90"))))
tab <- tableGrob(signif(tab,7),  theme = ttheme)
ggsave(grid.arrange(tab), 
       file = "COVID-19-IT_infected_table.png", 
       width = 6, height = 1.3, dpi = 300)
```


```{R, out.width="100%"}
cols <- c("Exponential" = "red3", "Logistic" = "dodgerblue3",
          "Gompertz" = "azure4", "Richards" = "forestgreen")

ggplot(data, aes(x = date, y = y)) + 
  geom_point() +
  geom_line(aes(y = fitted(mod1), color = "Exponential")) +
  geom_line(aes(y = fitted(mod2), color = "Logistic")) +
  geom_line(aes(y = fitted(mod3), color = "Gompertz")) +
  # geom_line(aes(y = fitted(mod4), color = "Richards")) +
  labs(x = "", y = "Infected", color = "Model") +
  scale_color_manual(values = cols) +
  scale_y_continuous(breaks = seq(0, coef(mod2)[1], by = 1000),
                     minor_breaks = seq(0, coef(mod2)[1], by = 500)) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  theme_bw() +
  theme(legend.position = "top")
```

## Predictions

### Point estimates

```{R}
df = data.frame(x = seq(min(data$x), max(data$x)+14))
df = cbind(df, date = as.Date(df$x, origin = data$date[1]-1),
               fit1 = predict(mod1, newdata = df),
               fit2 = predict(mod2, newdata = df),
               fit3 = predict(mod3, newdata = df))
               # fit4 = predict(mod4, newdata = df))
ylim = c(0, max(df[,c("fit2", "fit3")]))
```

```{R, echo=-2, out.width="100%"}
ggplot(data, aes(x = date, y = y)) + 
  geom_point() +
  geom_line(data = df, aes(x = date, y = fit1, color = "Exponential")) +
  geom_line(data = df, aes(x = date, y = fit2, color = "Logistic")) +
  geom_line(data = df, aes(x = date, y = fit3, color = "Gompertz")) +
  # geom_line(data = df, aes(x = date, y = fit4, color = "Richards")) +
  coord_cartesian(ylim = ylim) +
  labs(x = "", y = "Infected", color = "Model") +
  scale_y_continuous(breaks = seq(0, max(ylim), by = 10000),
                     minor_breaks = seq(0, max(ylim), by = 5000)) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  scale_color_manual(values = cols) +
  theme_bw() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle=60, hjust=1))
ggsave(file = "COVID-19-IT_infected_plot.png", width = 7, height = 6, dpi = 300)
```

### Prediction intervals

```{R}
library(investr)
pred1 = cbind(df[,1:2], 
              predFit(mod1, newdata = df, interval = c("prediction"), level = 0.95))

pred2 = cbind(df[,1:2], 
              predFit(mod2, newdata = df, interval = c("prediction"), level = 0.95))

# pred3 <- cbind(df[,1:2],
#                predFit(mod3, newdata = df, interval = c("prediction"), level = 0.95))
# :-(( error 
pred3 = cbind(df[,1:2], fit = df$fit3, lwr = df$fit3, upr = df$fit3)

# pred4 = cbind(df[,1:2], 
#               predFit(mod4, newdata = df, interval = c("prediction"), level = 0.95))
```

```{R, echo=FALSE, eval=FALSE}
library(propagate)
pred1 = predictNLS(mod1, newdata = df["x"], interval = "prediction", level = 0.95, nsim = 1e5)
pred1 = cbind(df[,1:2], "fit" = pred1$summary[,1],
              "lwr" = pred1$summary[,11], "upr" = pred1$summary[,12])
pred2 = predictNLS(mod2, newdata = df["x"], interval = c("prediction"), level = 0.95, nsim = 1e5)
pred2 = cbind(df, "fit" = pred2$summary[,1],
              "lwr" = pred2$summary[,11], "upr" = pred2$summary[,12])
pred3 = predictNLS(mod3, newdata = df["x"], interval = c("prediction"), level = 0.95, nsim = 1e5)
pred3 = cbind(df, "fit" = pred3$summary[,1],
              "lwr" = pred3$summary[,11], "upr" = pred3$summary[,12])
```

```{R, echo=FALSE, eval=FALSE}
source("misc/predictNLS.R")
pred1 = predictNLS(mod1, newdata = df, interval = "prediction", level = 0.95, nsim = 1e5)
pred1 = cbind(df, pred1[c("fit", "lwr", "upr")])
pred2 = predictNLS(mod2, newdata = df, interval = c("prediction"), level = 0.95, nsim = 1e5)
pred2 = cbind(df, pred2[c("fit", "lwr", "upr")])
pred3 = predictNLS(mod3, newdata = df, interval = c("prediction"), level = 0.95, nsim = 1e5)
pred3 = cbind(df, pred3[c("fit", "lwr", "upr")])
```

```{R, echo=-2, out.width="100%"}
ggplot(data, aes(x = date, y = y)) + 
  geom_point() +
  geom_line(data = pred1, aes(x = date, y = fit, color = "Exponential")) +
  geom_line(data = pred2, aes(x = date, y = fit, color = "Logistic")) +
  geom_line(data = pred3, aes(x = date, y = fit, color = "Gompertz")) +
#  geom_line(data = pred4, aes(x = date, y = fit, color = "Richards")) +
  geom_ribbon(data = pred1, aes(x = date, ymin = lwr, ymax = upr), 
              inherit.aes = FALSE, fill = cols[1], alpha=0.3) +
  geom_ribbon(data = pred2, aes(x = date, ymin = lwr, ymax = upr), 
              inherit.aes = FALSE, fill = cols[2], alpha=0.3) +
  geom_ribbon(data = pred3, aes(x = date, ymin = lwr, ymax = upr),
              inherit.aes = FALSE, fill = cols[3], alpha=0.3) +
  # geom_ribbon(data = pred4, aes(x = date, ymin = lwr, ymax = upr), 
  #             inherit.aes = FALSE, fill = cols[4], alpha=0.3) +
  coord_cartesian(ylim = c(0, max(pred2$upr))) +
  labs(x = "", y = "Infected", color = "Model") +
  scale_y_continuous(minor_breaks = seq(0, max(pred2$upr), by = 5000)) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  scale_color_manual(values = cols) +
  theme_bw() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle=60, hjust=1))
```

# Modelling total deceased 

```{R}
# create data for analysis
data = data.frame(date = COVID19IT$data,
                  y = COVID19IT$deceduti)
data$x = as.numeric(data$date) - min(as.numeric(data$date)) + 1

DT::datatable(data, options = list("pageLength" = 5))
```

## Nonlinear grow models

### Exponential growth model

```{R}
mod1_start = lm(log(y) ~ x, data = data)
b = unname(coef(mod1_start))
start = list(th1 = log(b[1]), th2 = b[2])
exponential <- function(x, th1, th2) th1 * exp(th2 * x)
mod1 = nls(y ~ exponential(x, th1, th2), data = data, start = start)
summary(mod1)
```

### Logistic growth model

```{R}
mod2 = nls(y ~ SSlogis(x, Asym, xmid, scal), data = data)
summary(mod2)
```

### Gompertz growth model

```{R}
# mod3 = nls(y ~ SSgompertz(x, Asym, b2, b3), data = data)
# error :((
# manually set starting values
start = list(Asym = coef(mod2)[1])
tmp = list(y = log(log(start$Asym) - log(data$y)), x = data$x)
b = unname(coef(lm(y ~ x, data = tmp)))
start = c(start, c(b2 = exp(b[1]), b3 = exp(b[2])))
mod3 = nls(y ~ SSgompertz(x, Asym, b2, b3), data = data, start = start, 
           control = nls.control(maxiter = 10000))
summary(mod3)
```

### Richards growth model

```{R}
richards <- function(x, th1, th2, th3) th1*(1 - exp(-th2*x))^th3
Loss  <- function(th, y, x) sum((y - richards(x, th[1], th[2], th[3]))^2) 
start <- optim(par = c(coef(mod2)[1], 0.001, 1), fn = Loss, 
               y = data$y, x = data$x)$par
names(start) <- c("th1", "th2", "th3")
mod4 = nls(y ~ richards(x, th1, th2, th3), data = data, start = start,
           # trace = TRUE, # algorithm = "port", 
           control = nls.control(maxiter = 1000))
summary(mod4)
```

### Models comparison

```{R}
models = list("Exponential model" = mod1, 
              "Logistic model" = mod2, 
              "Gompertz model" = mod3,
              "Richards model" = mod4)
tab = data.frame(loglik = sapply(models, logLik),
                 df = sapply(models, function(m) attr(logLik(m), "df")),
                 Rsquare = sapply(models, function(m) 
                                  cor(data$y, fitted(m))^2),
                 AIC = sapply(models, AIC),
                 BIC = sapply(models, BIC))
knitr::kable(tab)
```

```{r, echo=FALSE}
ttheme <- ttheme_default(
  core = list(# bg_params = list(fill = NA, col=NA),
              fg_params=list(fontface=1, fontsize = 10)),
  colhead = list(fg_params=list(col="black", fontface=2, fontsize = 10)),
  rowhead = list(fg_params=list(col="black", fontface=2, hjust=0, x=0,
                                fontsize = 10),
                 bg_params=list(fill = c("grey95", "grey90"))))
tab <- tableGrob(signif(tab,7),  theme = ttheme)
ggsave(grid.arrange(tab), 
       file = "COVID-19-IT_deceased_table.png", 
       width = 6, height = 1.3, dpi = 300)
```


```{R, out.width="100%"}
cols <- c("Exponential" = "red3", "Logistic" = "dodgerblue3",
          "Gompertz" = "azure4", "Richards" = "forestgreen")

ggplot(data, aes(x = date, y = y)) + 
  geom_point() +
  geom_line(aes(y = fitted(mod1), color = "Exponential")) +
  geom_line(aes(y = fitted(mod2), color = "Logistic")) +
  geom_line(aes(y = fitted(mod3), color = "Gompertz")) +
  geom_line(aes(y = fitted(mod4), color = "Richards")) +
  labs(x = "", y = "Deceased", color = "Model") +
  scale_color_manual(values = cols) +
  scale_y_continuous(breaks = seq(0, coef(mod2)[1], by = 500),
                     minor_breaks = seq(0, coef(mod2)[1], by = 100)) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  theme_bw() +
  theme(legend.position = "top")
```

## Predictions

### Point estimates

```{R}
df = data.frame(x = seq(min(data$x), max(data$x)+14))
df = cbind(df, date = as.Date(df$x, origin = data$date[1]-1),
               fit1 = predict(mod1, newdata = df),
               fit2 = predict(mod2, newdata = df),
               fit3 = predict(mod3, newdata = df),
               fit4 = predict(mod4, newdata = df))
ylim = c(0, max(df[,-(1:3)]))
```

```{R, echo=-2, out.width="100%"}
ggplot(data, aes(x = date, y = y)) + 
  geom_point() +
  geom_line(data = df, aes(x = date, y = fit1, color = "Exponential")) +
  geom_line(data = df, aes(x = date, y = fit2, color = "Logistic")) +
  geom_line(data = df, aes(x = date, y = fit3, color = "Gompertz")) +
  geom_line(data = df, aes(x = date, y = fit4, color = "Richards")) +
  coord_cartesian(ylim = ylim) +
  labs(x = "", y = "Deceased", color = "Model") +
  scale_y_continuous(breaks = seq(0, max(ylim), by = 1000),
                     minor_breaks = seq(0, max(ylim), by = 1000)) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  scale_color_manual(values = cols) +
  theme_bw() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle=60, hjust=1))
ggsave(file = "COVID-19-IT_deceased_plot.png", width = 7, height = 6, dpi = 300)
```

### Prediction intervals

```{R}
library(investr)
pred1 = cbind(df[,1:2], 
              predFit(mod1, newdata = df, interval = c("prediction"), level = 0.95))

pred2 = cbind(df[,1:2], 
              predFit(mod2, newdata = df, interval = c("prediction"), level = 0.95))

pred3 <- cbind(df[,1:2],
               predFit(mod3, newdata = df, interval = c("prediction"), level = 0.95))
# pred3 = cbind(df[,1:2], fit = df$fit3, lwr = df$fit3, upr = df$fit3)

# pred4 = cbind(df[,1:2],
#               predFit(mod4, newdata = df, interval = c("prediction"), level = 0.95))
# error :((
pred4 = cbind(df[,1:2], fit = df$fit4, lwr = df$fit4, upr = df$fit4)
```

```{R, echo=-2, out.width="100%"}
ggplot(data, aes(x = date, y = y)) + 
  geom_point() +
  geom_line(data = pred1, aes(x = date, y = fit, color = "Exponential")) +
  geom_line(data = pred2, aes(x = date, y = fit, color = "Logistic")) +
  geom_line(data = pred3, aes(x = date, y = fit, color = "Gompertz")) +
  geom_line(data = pred4, aes(x = date, y = fit, color = "Richards")) +
  geom_ribbon(data = pred1, aes(x = date, ymin = lwr, ymax = upr), 
              inherit.aes = FALSE, fill = cols[1], alpha=0.3) +
  geom_ribbon(data = pred2, aes(x = date, ymin = lwr, ymax = upr), 
              inherit.aes = FALSE, fill = cols[2], alpha=0.3) +
  geom_ribbon(data = pred3, aes(x = date, ymin = lwr, ymax = upr),
              inherit.aes = FALSE, fill = cols[3], alpha=0.3) +
  geom_ribbon(data = pred4, aes(x = date, ymin = lwr, ymax = upr), 
              inherit.aes = FALSE, fill = cols[4], alpha=0.3) +
  coord_cartesian(ylim = c(0, max(pred2$upr))) +
  labs(x = "", y = "Deceased", color = "Model") +
  scale_y_continuous(breaks = seq(0, max(pred2$upr), by = 500),
                     minor_breaks = seq(0, max(pred2$upr), by = 250)) +
  scale_x_date(date_breaks = "2 day", date_labels =  "%b%d",
               minor_breaks = "1 day") +
  scale_color_manual(values = cols) +
  theme_bw() +
  theme(legend.position = "top",
        axis.text.x = element_text(angle=60, hjust=1))
```
